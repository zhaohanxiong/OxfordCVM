# -------------------- Application Dependencies --------------------
library(data.table)
library(shiny)
library(ggplot2)

# read from AWS or locally
local = TRUE

# set deploy option as true or false
deploy = FALSE

# -------------------- Connect to Data Base --------------------
if (!local) { # connecting to AWS
  
  library(rjson)
  library(RPostgres)
  #library(aws.s3)
  
  # retrieve s3 credentials
  #aws_cred = read.csv("../../../keys/aws/s3.csv")
  
  # create connection to S3
  #Sys.setenv("AWS_ACCESS_KEY_ID" = aws_cred$Access.key.ID,
  #           "AWS_SECRET_ACCESS_KEY" = aws_cred$Secret.access.key,
  #           "AWS_DEFAULT_REGION" = "us-east-1"
  #)
  
  # read table from s3 using data.table and convert to dataframe
  #ukb_df = s3read_using(FUN = data.table::fread,
  #                      bucket = "biobank-s3", object = "ukb_num.csv")
  #ukb_df = data.frame(ukb_df)
  
  # retrieve rds credentials
  aws_cred =  fromJSON(file = "../../../../keys/aws/postgresql.json")
  
  # create connection to RDS
  con = dbConnect(RPostgres::Postgres(),
                  dbname = aws_cred$database, 
                  host = aws_cred$host, port = 5432, 
                  user = aws_cred$user, password = aws_cred$passw)
  
  # load and store tables
  varnames = dbFetch(dbSendQuery(con, "SELECT * FROM ukb_varnames"))
  pseudotimes = dbFetch(dbSendQuery(con, "SELECT * FROM psuedotimes"))
  ukb_df = dbFetch(dbSendQuery(con, "SELECT * FROM ukb_num_reduced"))
  
  # set up SSH tunnel using ssh package
  
  # secure credentials with config and options
  
} else { # read from local storage
  
  # set data path
  path = "../../modelling/NeuroPM/io/" # "C:/Users/zxiong/Desktop/io"
  
  # load variables used in cTI
  varnames = read.csv(file.path(path, "ukb_varnames.csv"), header=TRUE)
  
  # load ukb raw variables
  ukb_df = data.frame(fread(file.path(path, "ukb_num_reduced.csv"),header=TRUE))
  
  # load output of cTI
  pseudotimes = read.csv(file.path(path, "pseudotimes.csv"), header=TRUE)
  
}

# -------------------- Preprocess On-The-Fly --------------------
# combine data frames together
ukb_df = cbind(pseudotimes, ukb_df)
ukb_df = ukb_df[, unique(colnames(ukb_df))]

# set some variables as categorical
ukb_df$bp_group = factor(ukb_df$bp_group)
ukb_df$X31.0.0 = factor(ifelse(ukb_df$X31.0 == 0, "Female", "Male"))
ukb_df$trajectory = factor(ukb_df$trajectory)

# only keep varnames which are in UKB dataframe
varnames = varnames[varnames$colname %in% colnames(ukb_df), ]

# -------------------- Run Shiny Application --------------------
# deploy on shinyapp.io (hosted by R-Shiny)
if (deploy) {
  
  # load shinyapps.io dependency
  library(rsconnect)
  
  # read token and secret
  shiny_io_token = readLines("../../../../keys/shiny/account.token")
  shiny_io_secret = readLines("../../../../keys/shiny/account.secret")
  
  # connect to account hosted on shinyapps.io
  rsconnect::setAccountInfo(name = 'zhaohanxiong',
                            token = shiny_io_token,
                            secret = shiny_io_secret)
  
  # deploy to shinyapps.io
  rsconnect::deployApp('.')
  
} else { # host locally on computer
  
  # Create the R shiny app
  runApp(appDir = ".",
         display.mode = "showcase",
         test.mode = getOption("shiny.testmode", FALSE))
  
}
