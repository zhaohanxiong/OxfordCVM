### Tutorials
DNA Nexus provides cloud computing infrastructure and large-scale data analysis for the UK Biobank (and other datasets) by acting as an intermediary between the user and AWS EC2 (compute) and AWS S3 (storage). The organization has a Youtube channel which provides tutorials. I have included a few helpful videos here, but there are many others online. DNA Nexus also holds frequent workshops as well as customer support.

- UK Biobank (UKB) Research Analysis Platform (RAP) Access and Setup
  - https://youtube.com/watch?v=RZPMmobKnTw&si=EnSIkaIECMiOmarE&t=2315

- R Studio Workbench on RAP
  - https://www.youtube.com/watch?v=iy22sxlj5Ik&list=PLRkZ0Fz-n3Z7Jg0Vz4vudLYnBza4EUGLM&index=7

- Accessing Project Files Using DNA Nexus file system
  - https://www.youtube.com/watch?v=glIjnFxlw-I

### Platform Setup and Data Access
The DNA Nexus UKB RAP links directly with your UKB AMS account. The steps for platform setup and data access so you are able to start analysis is as follows:
1) Get access to UK Biobank dataset:
   - Submit a grant application, pay fees, to get access (_Winok to describe more_)
   - Leech off someone who already has access and add you to their application
   - Make an account on AMS (access management system): https://bbams.ndph.ox.ac.uk/ams
   - View "Applications" tab on the left hand side to see your projects and access data

2) Get access to UKB RAP:
   - Make an account on UKB RAP: https://ukbiobank.dnanexus.com/landing
   - Do NOT make an ccount on DNA Nexus homepage (https://platform.dnanexus.com/) as this is the general account and not the UKB platform

3) Connect UKB RAP to AMS:
   - Once you have finished the UKB RAP account sign up process, you will get an email activation
   - Click the link in the email to be prompted back into UKB RAP
   - Once there, you will be automatically prompted to sign-in to your UKB AMS account through their portal
   - Enter your AMS details to link your AMS and UKB RAP accounts
 
4) Data access:
   - Once you're logged in and everything is linked, navigate to the "Project" tab on the top left
   - Click the green "New Project" button on the top right
   - Enter a name for your project (date by default)
   - Under the "UK Biobank" section, enter the application ID that matches that of the ID displayed on your AMS "Applications" section
   - Tick the "Dispense data to the project" box
   - Select the billing to your default account
   - Click "Create Project" to finish
   - Your UKB RAP "Projects" section should now have a new row showing the project you just created which is attached to your UKB application (AMS) as well as a "Status" column showing the progress of the data being loaded (usually takes a day)
   - Once the data has finished dispensing, the status will change to "Ready" which means you are ready to start analysis

5.1) Starting a R studio session:
    - Click on the 2nd tab on the top left "Tools" > "R Studio" > "New R Studio"
    - In pop up window, under project, select the project which contains the data you want to analyze, then click "start environment"
    - Your R studio session will initialize and then launch, the "Status" column will say "Ready" in green when its ready for use
    - Click on the name of your session to be forwarded to a new window, then click "New Session" > "Start Session" and you will see the familiar R studio integrated development environment (IDE)
    - Your session will be started in a "Cluster" environment, which means that it is an isolated environment with a specific set of memory and computational resource
    - This is a brand new environment created by AWS EC2 which contains nothing, which means you have to set up your entire pipeline from scratch everytime
    - This can be easily done with bash scripts to pull code from github, install all dependencies, and run the pre-defined code
    - Once you are done, click the terminate session on the right hand side of the row to close the session

5.2) Starting R studio session from project:
    - Click into the project you want to perform analysis for in the "Projects" tab of your UKB RAP homepage
    - You will then see a file system of all the data associated with this project application
    - You can navigate in the directories to get a feel for the structure of the data
    - You can also open and download individual files and look at them on your own device
    - To use code to perform analysis, click the green "Start Analysis" button, scroll down until you see "R Studio Workbench", then click "Run selected"
    - This will lead you to a new pop up window where you can configure your session, then click "start analysis", this will initialize your R studio session for the selected project
    - Wait for it to load a little while, and click the "worker URL" along the top to enter into the session, then you can set up your R studio similarily as above
    - You can monitor all your sessions with the "Monitor" tab which summarizes all your active/terminated sessions, here you can also access your R studio by clicking link in each row corresponding to your active sesssion

6) Data Analysis in R:
    - The environment created here is an "instance" on the cloud and has no resources inside apart from R
    - To access project data files, we need to use the ```dx``` package provided by UKB RAP, which works in the terminal
    - ```dx ls``` will list all the data resources in your project, e.g. ```dx ls Bulk``` lists all the bulk data files
    - Alternatively, you can access the files directly, files for each project are all stored in the path ```/mnt/project/```, which will lead to you to see everything you could see interactively in the GUI filesystem when you first click into your project
      - Example of reading in a file with R: ```df = read.delim("/mnt/project/Showcase metadata/field.tsv")```
      - Of course, you can access all the other files as well in a similar manner (using different read functions for different file formats) for any file located in the ```/mnt/project``` directory
      - Imaging data (Bulk data) are located in ```/mnt/project/Bulk```
      - e.g. the terminal command ```ls -l /mnt/project/Bulk/Heart MRI/CINE tagging/10``` lists all cine MRIs for patients starting with the "10" ID
      - ```ls /mnt/project/Bulk/Heart MRI/CINE tagging/10 | wc -l``` counts the number of files in that directory
      - Once you have the data loaded into your R studio workspace, then you go about performing whatever analysis you choose
    - Lets say you have performed some analysis, and you want to save your output (stored as the variable ```df_out```) to your own computer
      - Using the previous file loaded, you can perform ```df_out = df[df$availability == 4, ]``` to make some mock subset of the data
      - ```write.csv(df_out, file = "my_output.csv")``` will write this file to inside your R studio instance to your current working directory
      - ```system("dx upload my_output.csv")``` will then upload this file to the ```/mnt/project``` path where it will be accessible in the projects filesystem GUI
      - Make sure you run this command inside the working directory which contains the ```my_output.csv``` file
      - ```/mnt/project``` is read-only so you have to use ```dx``` to upload any files
      - ```/mnt/project``` is automatically the base path for all ```dx``` commands, so any further path would stem from this
      - e.g. ```system("dx upload my_output.csv --path . --destination /Bulk/")``` will upload ```my_output.csv``` located in ```.``` to ```/mnt/project/Bulk```
 
7) Full code for the example above (load, process, write, upload)
```
df = read.delim("/mnt/project/Showcase metadata/field.tsv")
df_out = df[df$availability == 4, ]
write.csv(df_out, file = "my_output.csv")
system("dx upload my_output.csv --path . --destination /Bulk/")
```
